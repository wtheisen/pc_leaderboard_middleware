{% extends "base.html" %}
{% block body %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/keymap/vim.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/hint/show-hint.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/hint/python-hint.min.js"></script>

<h2>Online Editor</h2>
<p>
    Write your solution below and submit to see graded results.
</p>

<style>
    .CodeMirror {
        border: 1px solid #ccc;
        height: 500px; /* Increase the height */
    }
    /* Results layout */
    .results-card {
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #fff;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        margin-top: 20px;
    }
    .results-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border-bottom: 1px solid #eee;
        background: #f9fafb;
    }
    .results-meta {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }
    .results-body {
        padding: 12px;
    }
    .score-badge {
        font-size: 14px;
        padding: 6px 10px;
        border-radius: 16px;
        color: #fff;
        display: inline-block;
        min-width: 80px;
        text-align: center;
    }
    .score-good { background: #28a745; }
    .score-ok { background: #f0ad4e; }
    .score-bad { background: #d9534f; }
    .label-result { font-size: 12px; }
    .progress { margin: 6px 0 0 0; height: 10px; }
    .progress-bar { line-height: 10px; }

    /* Diff styling */
    .diff-container {
        background: #f8f9fa;
        border: 1px solid #e2e6ea;
        border-radius: 6px;
        overflow: hidden;
        font-family: Menlo, Monaco, Consolas, monospace;
    }
    .diff-header { display: grid; grid-template-columns: 64px 64px 1fr; padding: 6px 10px; background: #e9ecef; font-weight: 600; border-bottom: 1px solid #d9dee2; }
    .diff-line { display: grid; grid-template-columns: 64px 64px 1fr; align-items: baseline; white-space: pre; padding: 3px 10px; }
    .diff-num { color: #6c757d; text-align: right; padding-right: 8px; font-variant-numeric: tabular-nums; }
    .diff-code { overflow: auto; }
    .diff-sep { color: #adb5bd; padding: 0 6px; }
    .diff-inline-add { background: #d1f2d7; color: #116329; padding: 0 2px; border-radius: 2px; }
    .diff-inline-del { background: #f7d6d9; color: #8c1d18; padding: 0 2px; border-radius: 2px; }
    .diff-hunk { background: #f1f3f5 !important; color: #495057; font-weight: 600; border-left: 4px solid #adb5bd; }
    .diff-add  { background: #d1f2d7 !important; color: #116329; border-left: 4px solid #2ea043; }
    .diff-del  { background: #f7d6d9 !important; color: #8c1d18; border-left: 4px solid #d73a49; }
    .diff-file { background: #fff3cd !important; color: #8a6d3b; border-left: 4px solid #f0ad4e; }
    .diff-ctx  { background: #ffffff; color: #212529; }
    .section-title { margin: 12px 0 6px; font-weight: 600; }
    .muted { color: #6c757d; }
    .json-raw { max-height: 220px; overflow: auto; background: #f8f9fa; border: 1px solid #eee; padding: 8px; border-radius: 4px; }

    /* Side-by-side diff (pipe format) */
    .sbs-container { background: #fff; border: 1px solid #e2e6ea; border-radius: 6px; }
    .sbs-header { display: grid; grid-template-columns: 64px 1fr 64px 1fr; gap: 0; padding: 6px 10px; background: #e9ecef; border-bottom: 1px solid #d9dee2; font-weight: 600; }
    .sbs-row { display: grid; grid-template-columns: 64px 1fr 64px 1fr; gap: 0; padding: 3px 10px; white-space: pre-wrap; }
    .sbs-lnum { color: #6c757d; text-align: right; padding-right: 8px; font-variant-numeric: tabular-nums; }
    .sbs-code { overflow: auto; }
    .sbs-left.sbs-del { background: #f7d6d9; color: #8c1d18; }
    .sbs-right.sbs-add { background: #d1f2d7; color: #116329; }
    .sbs-left.sbs-eq, .sbs-right.sbs-eq { background: #ffffff; color: #212529; }
    .sbs-label { color: #495057; }
</style>

<div class="container">
    <!-- Editor Section -->
    <div style="padding: 10px; border: 1px solid #ccc; background-color: #fff; margin-bottom: 20px;">
        <div class="form-inline" style="margin-bottom: 8px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <label for="assignment-select" class="control-label">Assignment:</label>
            <select id="assignment-select" class="form-control"></select>
            <label for="submission-token" class="control-label">Token:</label>
            <input type="text" id="submission-token" class="form-control" placeholder="Enter your submission token">
            <button id="submit-btn" class="btn btn-primary" onclick="submitCode()"><i class="fa fa-paper-plane"></i> Submit</button>
            <button id="desc-btn" type="button" class="btn btn-default" onclick="openDescription()"><i class="fa fa-book"></i> View Description</button>
        </div>
        <textarea id="python-editor"></textarea>
    </div>

    <!-- Output Results Section -->
    <div id="diff-results" class="results-card" style="display: none;">
        <div class="results-header">
            <div class="results-meta">
                <span id="result-label" class="label label-default label-result">Pending</span>
                <span id="score-badge" class="score-badge score-bad">Score: 0</span>
                <span class="muted">Time: <strong id="time">0.000</strong>s</span>
                <span class="muted">Value: <strong id="value">-</strong></span>
            </div>
            <div style="min-width: 220px;">
                <div class="progress">
                    <div id="score-progress" class="progress-bar progress-bar-danger" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
        <div class="results-body">
            <!-- Tabs for Diff / Stdout / Stderr -->
            <ul class="nav nav-tabs" id="result-tabs" style="margin-bottom: 10px;">
              <li id="tab-diff-li" class="active"><a href="#tab-diff" data-toggle="tab"><i class="fa fa-code"></i> Diff</a></li>
              <li id="tab-stdout-li"><a href="#tab-stdout" data-toggle="tab"><i class="fa fa-terminal"></i> Stdout</a></li>
              <li id="tab-stdin-li"><a href="#tab-stdin" data-toggle="tab"><i class="fa fa-keyboard"></i> Stdin</a></li>
              <li id="tab-stderr-li"><a href="#tab-stderr" data-toggle="tab"><i class="fa fa-exclamation-triangle"></i> Stderr</a></li>
            </ul>
            <div class="tab-content">
              <div class="tab-pane active" id="tab-diff">
                <div id="diff-content" class="diff-container"></div>
              </div>
              <div class="tab-pane" id="tab-stdout">
                <pre id="stdout-content" class="alert alert-info" style="white-space: pre-wrap; margin: 0;"></pre>
              </div>
              <div class="tab-pane" id="tab-stdin">
                <pre id="stdin-content" class="alert alert-default" style="white-space: pre-wrap; margin: 0;"></pre>
              </div>
              <div class="tab-pane" id="tab-stderr">
                <pre id="stderr-content" class="alert alert-danger" style="white-space: pre-wrap; margin: 0;"></pre>
              </div>
            </div>

            <div id="raw-json-section" style="display:none; margin-top: 10px;">
                <div class="section-title">Details</div>
                <pre id="raw-json" class="json-raw"></pre>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display:none; position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.7); z-index: 2000;">
        <div style="position:absolute; top:50%; left:50%; transform: translate(-50%, -50%); text-align:center;">
            <i class="fa fa-spinner fa-spin" style="font-size: 28px;"></i>
            <div style="margin-top:8px;">Submitting...</div>
        </div>
    </div>

    <!-- Description Modal -->
    <div class="modal fade" id="descriptionModal" tabindex="-1" role="dialog" aria-labelledby="descriptionModalLabel">
      <div class="modal-dialog" role="document" style="width: 800px; max-width: 95vw;">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="descriptionModalLabel">Assignment Description</h4>
          </div>
          <div class="modal-body">
            <div id="description-content" style="max-height: 70vh; overflow: auto;"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
</div>

<script>
    var editor = CodeMirror.fromTextArea(document.getElementById("python-editor"), {
            mode: "python",
            lineNumbers: true,
            theme: "default",
            keyMap: "vim",
            extraKeys: {"Ctrl-Space": "autocomplete"}
        });

    document.addEventListener('DOMContentLoaded', function() {
        
        // Load saved content from localStorage
        var savedContent = localStorage.getItem('editorContent');
        if (savedContent) {
            editor.setValue(savedContent);
        }

        // Save content to localStorage on change
        editor.on('change', function() {
            localStorage.setItem('editorContent', editor.getValue());
        });

        fetch('/list_assignments')
            .then(response => response.json())
            .then(assignments => {
                var select = document.getElementById('assignment-select');
                assignments.forEach(assignment => {
                    var option = document.createElement('option');
                    option.value = assignment;
                    option.textContent = assignment;
                    select.appendChild(option);
                });

                // Trigger change event to load the template for the first assignment
                if (assignments.length > 0) {
                    select.value = assignments[0];
                    select.dispatchEvent(new Event('change'));
                }
            });

        document.getElementById('assignment-select').addEventListener('change', function() {
            var assignment = this.value;
            fetch('/get_template/' + assignment)
                .then(response => response.text())
                .then(template => {
                    editor.setValue(template);
                });
        });
    });

    function setScoreVisuals(scoreNum) {
        var percent = isFinite(scoreNum) ? (scoreNum <= 1 ? scoreNum * 100 : scoreNum) : 0;
        percent = Math.max(0, Math.min(100, percent));

        var badge = document.getElementById('score-badge');
        badge.classList.remove('score-good', 'score-ok', 'score-bad');
        var bar = document.getElementById('score-progress');
        bar.classList.remove('progress-bar-success', 'progress-bar-warning', 'progress-bar-danger');

        var cls = 'score-bad';
        var barCls = 'progress-bar-danger';
        if (percent >= 85) { cls = 'score-good'; barCls = 'progress-bar-success'; }
        else if (percent >= 60) { cls = 'score-ok'; barCls = 'progress-bar-warning'; }

        badge.classList.add(cls);
        bar.classList.add(barCls);
        badge.textContent = 'Score: ' + percent.toFixed(0);
        bar.style.width = percent.toFixed(0) + '%';
    }

    function renderDiff(text) {
        if (!text) return '';
        var lines = text.replace(/\r\n?/g, '\n').split('\n');

        // Detect pipe side-by-side format (>50% of non-empty lines contain a pipe)
        var nonEmpty = lines.filter(function(l){ return l.trim().length > 0; });
        var pipeCount = nonEmpty.filter(function(l){ return l.indexOf('|') !== -1 && !l.startsWith('+++') && !l.startsWith('---') && !l.startsWith('@@'); }).length;
        var useSBS = pipeCount > (nonEmpty.length * 0.5);

        if (useSBS) {
            var lnum = 1, rnum = 1;
            var sbs = '<div class="sbs-container">' +
                      '<div class="sbs-header"><div class="sbs-label">Line</div><div class="sbs-label">Your Output</div><div class="sbs-label">Line</div><div class="sbs-label">Expected Output</div></div>';
            var prevSingleSide = null; // 'left' or 'right'
            var prevSingleText = '';
            for (var i=0; i<lines.length; ) {
                var ln = lines[i];
                if (!ln || !ln.trim()) { i++; continue; }

                var left = null, right = null;

                // Case A: right-only line starting with a pipe
                if (/^\s*\|\s*/.test(ln)) {
                    right = ln.replace(/^\s*\|\s*/, '');
                    i += 1;
                // Case B: single line with explicit pipe separating both sides
                } else if (ln.indexOf('|') !== -1) {
                    var idx = ln.indexOf('|');
                    left = ln.slice(0, idx).replace(/\s+$/, '');
                    right = ln.slice(idx+1).replace(/^\s+/, '');
                    i += 1;
                // Case C: single line with two arrays separated by whitespace (no pipe)
                } else if (/^\s*\[[\s\S]*?\]\s+\[[\s\S]*?\]\s*$/.test(ln)) {
                    var m = ln.match(/^\s*(\[[\s\S]*?\])\s+(\[[\s\S]*?\])\s*$/);
                    if (m) { left = m[1]; right = m[2]; }
                    i += 1;
                // Case D: left-only
                } else {
                    left = ln;
                    i += 1;
                }

                function normTxt(s){ return s.replace(/[\t ]+/g,' ').trim(); }
                var leftEsc = left !== null ? left.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';
                var rightEsc = right !== null ? right.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';
                var equal = (left !== null && right !== null) && (normTxt(left) === normTxt(right));

                // Collapse immediate duplicates when only one side repeats
                if (left !== null && right === null) {
                    var norm = normTxt(left);
                    if (prevSingleSide === 'left' && prevSingleText === norm) {
                        continue;
                    }
                    prevSingleSide = 'left';
                    prevSingleText = norm;
                } else if (right !== null && left === null) {
                    var normr = normTxt(right);
                    if (prevSingleSide === 'right' && prevSingleText === normr) {
                        continue;
                    }
                    prevSingleSide = 'right';
                    prevSingleText = normr;
                } else {
                    prevSingleSide = null;
                    prevSingleText = '';
                }

                sbs += '<div class="sbs-row">' +
                       '<div class="sbs-lnum">' + (left !== null ? lnum++ : '') + '</div>' +
                       '<div class="sbs-code sbs-left ' + (left === null ? 'sbs-eq' : (equal ? 'sbs-eq' : 'sbs-del')) + '">' + leftEsc + '</div>' +
                       '<div class="sbs-lnum">' + (right !== null ? rnum++ : '') + '</div>' +
                       '<div class="sbs-code sbs-right ' + (right === null ? 'sbs-eq' : (equal ? 'sbs-eq' : 'sbs-add')) + '">' + rightEsc + '</div>' +
                       '</div>';
            }
            sbs += '</div>';
            return sbs;
        }

        var html = '<div class="diff-header"><div class="diff-num">Old</div><div class="diff-num">New</div><div>Code</div></div>';
        var lNum = null, rNum = null;
        for (var i = 0; i < lines.length; i++) {
            var ln = lines[i];
            var cls = 'diff-ctx';
            var lDisp = '', rDisp = '';
            var codeHTML = null;
            if (ln.startsWith('diff ') || ln.startsWith('+++') || ln.startsWith('---')) {
                cls = 'diff-file';
            } else if (ln.startsWith('@@')) {
                cls = 'diff-hunk';
                var m = ln.match(/@@\s-([0-9]+)(?:,\d+)?\s\+([0-9]+)(?:,\d+)?\s@@/);
                if (m) { lNum = parseInt(m[1], 10); rNum = parseInt(m[2], 10); }
                else { lNum = null; rNum = null; }
            } else if (/\|/.test(ln) && !ln.startsWith('+') && !ln.startsWith('-')) {
                // Pipe-delimited side-by-side format: left | right
                var idx = ln.indexOf('|');
                var left = ln.slice(0, idx).replace(/\s+$/,'');
                var right = ln.slice(idx+1).replace(/^\s+/, '');
                var leftEsc = left.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                var rightEsc = right.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                codeHTML = '<span class="diff-inline-del">' + leftEsc + '</span>' +
                           '<span class="diff-sep">|</span>' +
                           '<span class="diff-inline-add">' + rightEsc + '</span>';
            } else if (ln.startsWith('+')) {
                cls = 'diff-add';
                if (rNum != null) { rDisp = String(rNum); rNum++; }
            } else if (ln.startsWith('-')) {
                cls = 'diff-del';
                if (lNum != null) { lDisp = String(lNum); lNum++; }
            } else if (ln.startsWith(' ')) {
                // context line in unified diff
                if (lNum != null) { lDisp = String(lNum); lNum++; }
                if (rNum != null) { rDisp = String(rNum); rNum++; }
            } else if (ln.startsWith('\\')) {
                // metadata line like "\\ No newline at end of file"
                cls = 'diff-ctx';
            } else if (/^Expected:?/i.test(ln)) {
                cls = 'diff-del';
            } else if (/^Got:?/i.test(ln) || /^Actual:?/i.test(ln)) {
                cls = 'diff-add';
            } else {
                // Fallback: treat as context
                if (lNum != null) { lDisp = String(lNum); lNum++; }
                if (rNum != null) { rDisp = String(rNum); rNum++; }
            }
            var code = codeHTML !== null ? codeHTML : ln.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            html += '<div class="diff-line ' + cls + '"><div class="diff-num">' + (lDisp||'') + '</div><div class="diff-num">' + (rDisp||'') + '</div><div class="diff-code">' + code + '</div></div>';
        }
        return html;
    }

    function isSuccess(result, score) {
        if (result && typeof result === 'string') {
            var r = result.toLowerCase();
            if (r.includes('pass') || r.includes('success') || r === 'ok') return true;
        }
        var num = Number(score);
        if (isFinite(num)) {
            var pct = num <= 1 ? num * 100 : num;
            if (pct >= 60) return true;
        }
        return false;
    }

    function showRawJson(data) {
        var raw = document.getElementById('raw-json');
        raw.textContent = JSON.stringify(data, null, 2);
        document.getElementById('raw-json-section').style.display = 'block';
    }

    function toggleLoading(show) {
        document.getElementById('loading-overlay').style.display = show ? 'block' : 'none';
        var btn = document.getElementById('submit-btn');
        if (btn) {
            btn.disabled = !!show;
            btn.innerHTML = show ? '<i class="fa fa-spinner fa-spin"></i> Submitting...' : '<i class="fa fa-paper-plane"></i> Submit';
        }
    }

    function submitCode() {
        var code = editor.getValue();
        var assignment = document.getElementById("assignment-select").value;
        var submissionToken = document.getElementById("submission-token").value;

        // Create a Blob from the code
        var codeBlob = new Blob([code], { type: 'text/plain' });
        var formData = new FormData();
        formData.append('source', codeBlob, 'program.py');

        // Send code, assignment, and submission token to backend for testing
        toggleLoading(true);
        fetch('/code/' + assignment, {
            method: 'POST',
            headers: {
                'X-Dredd-Code-Slug': 'debug',
                'X-Submission-Token': submissionToken
            },
            body: formData
        })
        .then(response => {
            if (response.status === 403) {
                return response.text().then(message => {
                    alert("Error 403: " + message);
                    throw new Error("403 Forbidden");
                });
            }
            return response.json();
        })
        .then(data => {
            // Basic fields
            var scoreNum = Number(data.score);
            if (!isFinite(scoreNum)) scoreNum = 0;
            setScoreVisuals(scoreNum);

            var ok = isSuccess(data.result, data.score);
            var resultLabel = document.getElementById('result-label');
            resultLabel.textContent = (data.result || (ok ? 'Success' : 'Failure'));
            resultLabel.className = 'label label-' + (ok ? 'success' : 'danger') + ' label-result';

            if (typeof data.time === 'number') {
                document.getElementById('time').textContent = data.time.toFixed(3);
            } else if (!isNaN(parseFloat(data.time))) {
                document.getElementById('time').textContent = parseFloat(data.time).toFixed(3);
            } else {
                document.getElementById('time').textContent = '-';
            }
            document.getElementById('value').textContent = (data.value !== undefined && data.value !== null) ? data.value : '-';

            // Populate tab contents
            var hasDiff = !!(data.diff && data.diff.length);
            var hasStdout = !!(data.stdout && data.stdout.length);
            var hasStderr = !!(data.stderr && data.stderr.length);
            var hasStdin = !!(data.stdin && data.stdin.length);

            document.getElementById('diff-content').innerHTML = hasDiff ? renderDiff(data.diff) : '<div class="text-muted" style="padding:8px;">No diff available.</div>';
            document.getElementById('stdout-content').textContent = hasStdout ? data.stdout : '';
            if (document.getElementById('stdin-content')) {
                document.getElementById('stdin-content').textContent = hasStdin ? data.stdin : '';
            }
            document.getElementById('stderr-content').textContent = hasStderr ? data.stderr : '';

            // Show/hide tabs depending on content
            var diffLi = document.getElementById('tab-diff-li');
            var stdoutLi = document.getElementById('tab-stdout-li');
            var stdinLi = document.getElementById('tab-stdin-li');
            var stderrLi = document.getElementById('tab-stderr-li');

            diffLi.style.display = hasDiff ? '' : 'none';
            stdoutLi.style.display = hasStdout ? '' : 'none';
            if (stdinLi) stdinLi.style.display = hasStdin ? '' : 'none';
            stderrLi.style.display = hasStderr ? '' : 'none';

            // Activate first available tab
            var firstTab = null;
            if (hasDiff) firstTab = '#tab-diff';
            else if (hasStdout) firstTab = '#tab-stdout';
            else if (hasStdin) firstTab = '#tab-stdin';
            else if (hasStderr) firstTab = '#tab-stderr';
            if (firstTab) {
                $('#result-tabs a[href="' + firstTab + '"]').tab('show');
            }

            // Raw json for debugging / completeness
            showRawJson(data);

            // Show the results card
            document.getElementById('diff-results').style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Submission failed. Please try again.');
        })
        .finally(() => {
            toggleLoading(false);
        });
    }

    function openDescription() {
        var assignment = document.getElementById('assignment-select').value;
        // Try to fetch description (HTML preferred, fallback to Markdown)
        fetch('/get_description/' + assignment)
            .then(resp => resp.text().then(text => ({ contentType: resp.headers.get('Content-Type') || '', text })))
            .then(({ contentType, text }) => {
                var container = document.getElementById('description-content');
                if (contentType.includes('html')) {
                    container.innerHTML = text;
                } else {
                    container.innerHTML = renderMarkdown(text);
                }
                $('#descriptionModal').modal('show');
            })
            .catch(err => {
                console.error('Description fetch error:', err);
                document.getElementById('description-content').innerHTML = '<div class="alert alert-warning">No description available for this assignment.</div>';
                $('#descriptionModal').modal('show');
            });
    }

    // Minimal Markdown renderer for headings, lists, code fences, inline formatting
    function renderMarkdown(md) {
        if (!md) return '<div class="text-muted">(empty)</div>';
        // Escape HTML
        md = md.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        // Code fences
        var codeFenceRegex = /```([\s\S]*?)```/g;
        md = md.replace(codeFenceRegex, function(_, code) {
            return '<pre><code>' + code.trim() + '</code></pre>';
        });

        // Headings # to ######
        md = md.replace(/^######\s+(.*)$/gm, '<h6>$1</h6>')
               .replace(/^#####\s+(.*)$/gm, '<h5>$1</h5>')
               .replace(/^####\s+(.*)$/gm, '<h4>$1</h4>')
               .replace(/^###\s+(.*)$/gm, '<h3>$1</h3>')
               .replace(/^##\s+(.*)$/gm, '<h2>$1</h2>')
               .replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');

        // Lists (unordered)
        md = md.replace(/^(?:- |\* ).*(?:\n(?:- |\* ).*)*/gm, function(block) {
            var items = block.split(/\n/).map(function(line){ return line.replace(/^(?:- |\* )/, ''); });
            return '<ul>' + items.map(function(i){ return '<li>' + i + '</li>'; }).join('') + '</ul>';
        });

        // Ordered lists
        md = md.replace(/^(?:\d+\. ).*(?:\n(?:\d+\. ).*)*/gm, function(block) {
            var items = block.split(/\n/).map(function(line){ return line.replace(/^\d+\. /, ''); });
            return '<ol>' + items.map(function(i){ return '<li>' + i + '</li>'; }).join('') + '</ol>';
        });

        // Inline code
        md = md.replace(/`([^`]+)`/g, '<code>$1</code>');
        // Bold and italics (simple)
        md = md.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
        md = md.replace(/\*([^*]+)\*/g, '<em>$1</em>');
        // Links [text](url)
        md = md.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

        // Paragraphs: wrap standalone text lines into <p>
        var lines = md.split(/\n\n+/).map(function(chunk) {
            if (/^\s*<h\d|^\s*<ul>|^\s*<ol>|^\s*<pre>|^\s*<p>|^\s*<blockquote>/.test(chunk)) return chunk;
            return '<p>' + chunk.replace(/\n/g, '<br/>') + '</p>';
        });
        return lines.join('\n');
    }
</script>
{% endblock %}
