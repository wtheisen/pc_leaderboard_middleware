{% extends "base.html" %}
{% block body %}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    var refreshInterval = 60; // Refresh interval in seconds
    var countdown = refreshInterval;

    function updateLeaderboard() {
        $.getJSON("{{ url_for('leaderboard_data') }}", function(data) {
            // Update the leaderboard table with new data
            var tableBody = $("#leaderboardTable tbody");
            tableBody.empty(); // Clear existing rows

            $.each(data, function(index, entry) {
                var row = "<tr>";
                row += "<td>" + (entry.is_debug ? "*" : entry.position) + "</td>";
                row += "<td>" + entry.total_score.toFixed(2) + "</td>";
                row += "<td><a href='" + "{{ url_for('student_view', name='') }}" + entry.student_id + "'>" + entry.display_name + "</a></td>";
                row += "<td>" + entry.average_score.toFixed(2) + "</td>";
                row += "<td>" + entry.assignments_completed + " / 23 </td>";
                row += "<td><div class='progress-bar'><div class='progress' style='width: " + (entry.assignments_completed / 23 * 100).toFixed(0) + "%'></div></div></td>";
                row += "</tr>";
                tableBody.append(row);
            });
        });
    }

    function updateRecentSubmissions() {
        $.getJSON("{{ url_for('recent_submissions') }}", function(data) {
            var ticker = $("#recentSubmissionsTicker");
            ticker.empty();

            $.each(data, function(index, sub) {
                var studentLink = "<a href='" + "{{ url_for('student_view', name='') }}" + sub.student_id + "'>" + sub.student_name + "</a>";
                var assignmentLink = "<a href='" + "{{ url_for('assignment_view', name='') }}" + sub.assignment + "'>" + sub.assignment + "</a>";

                // Parse the date and format it without the year, in 12-hour format
                var date = new Date(sub.submission_time); // This should be in UTC
                var hours = date.getUTCHours(); // Use getUTCHours to get the correct hour
                var minutes = date.getUTCMinutes(); // Use getUTCMinutes to get the correct minutes
                var ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; // the hour '0' should be '12'
                minutes = minutes < 10 ? '0' + minutes : minutes;
                var formattedDate = (date.getUTCMonth() + 1) + '/' + date.getUTCDate() + ' ' + hours + ':' + minutes + ' ' + ampm;

                var item = "<div class='ticker-item'><b>Student:</b> " + studentLink + ", <b>Assignment:</b> " + assignmentLink + ", <b>Time:</b> " + formattedDate + "</div>";
                ticker.append(item);
            });
        });
    }

    function startCountdown() {
        countdown = refreshInterval;
        var countdownElement = document.getElementById("refreshCountdown");
        var countdownTimer = setInterval(function() {
            countdown--;
            countdownElement.textContent = countdown;
            if (countdown <= 0) {
                clearInterval(countdownTimer);
                updateLeaderboard();
                updateRecentSubmissions();
                startCountdown(); // Restart countdown after refresh
            }
        }, 1000);
    }

    $(document).ready(function() {
        updateLeaderboard();
        updateRecentSubmissions();
        startCountdown();
    });
</script>

<div class="row mb-3 align-items-center">
    <div class="col-md-8 d-flex align-items-center justify-content-center">
        <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Filter Leaderboard..." class="form-control search-bar">
    </div>
    <div class="col-md-4 d-flex align-items-center justify-content-center" style="text-align: center; padding-top: 1%;">
        <p class="mb-0">Next refresh in: <span id="refreshCountdown">60</span> seconds</p>
    </div>
</div>

<br>

<div class="row">
    <table id="leaderboardTable" class="table condensed table-striped" border="2px solid black">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Total Points</th>
                <th>Student ID</th>
                <th>Average Assignment Points</th>
                <th>Challenges</th>
                <th>Progress</th>
            </tr>
        </thead>
        <tbody>
            <!-- Leaderboard data will be inserted here by JavaScript -->
        </tbody>
    </table>
</div>

<div class="row">
    <div class="page-header">
        <h2 id="logistics"><i class="fa fa-clock-o"></i> Recent Submissions</h2>
    </div>
</div>

<div class="row">
    <div id="recentSubmissionsTicker" class="ticker">
        <!-- Recent submissions will be inserted here by JavaScript -->
    </div>
</div>

<style>
.search-bar {
    width: 100%;
    border-radius: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: box-shadow 0.3s ease;
}
.search-bar:focus {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}
.bonus {
    color: #4CAF50;
    font-weight: bold;
}
.progress-bar {
    width: 100%;
    height: 20px;
    background-color: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
}
.progress {
    height: 100%;
    background-color: #4CAF50;
    transition: width 0.5s ease-in-out;
}
.ticker {
    width: 100%;
    overflow: hidden;
    white-space: nowrap;
    box-sizing: border-box;
    position: relative;
    display: flex;
    align-items: center;
}
.ticker-item {
    display: inline-block;
    padding: 0 2rem;
    animation: ticker 30s linear infinite;
}
@keyframes ticker {
    0% { transform: translateX(250%); }
    100% { transform: translateX(-100%); }
}
</style>

<script>
$(function () {
  $('[data-toggle="tooltip"]').tooltip();
});

function filterTable() {
    var input, filter, table, tr, td, i, txtValue;
    input = document.getElementById("searchInput");
    filter = input.value.toUpperCase();
    table = document.getElementById("leaderboardTable");
    tr = table.getElementsByTagName("tr");
    for (i = 1; i < tr.length; i++) {
        tr[i].style.display = "none";
        td = tr[i].getElementsByTagName("td");
        for (var j = 0; j < td.length; j++) {
            if (td[j]) {
                txtValue = td[j].textContent || td[j].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                    break;
                }
            }
        }
    }
}
</script>

<div class="row">
    <div class="page-header">
        <h2 id="logistics"><i class="fa fa-calculator"></i> Details</h2>
    </div>
</div>

<div class="row">
    This semester we're going to try something new. Throughout the course of the semester your challenges (and potentially a few other assignments) will gain you points based on four different metrics. Based on these points you'll be ranked against your classmates and will be entered in a competition for a small pool of bonus points. Your final submission for each challenge will be used to calculate points based on the formula below:
</div>

<br>

<div class="row">
    <div class="alert alert-info">
        <b>Scoring Formula:</b> 
        <pre>0.4 * Runtime Rank + 0.3 * Lint Rank + 0.2 * Submission Time Rank + 0.1 * Code Score</pre>
    </div>
</div>

<div class="row">
    <div class="alert alert-danger">
        <b>Stakes:</b> 5 bonus points for 1st place, 2 bonus points for 2nd, and 1 bonus point for 3rd, 4th, or 5th.
    </div>
</div>

<div class="row">
    In addition to the points given by the formula above, there are three more bonus points available for being the top in the three categories: Runtime, Submission Time, Lint Score. These are indicated by:
    <p class="label label-warning" data-toggle="tooltip" title="Lowest Average Runtime: 1 bonus point">Speedster</p>
    <p class="label label-info" data-toggle="tooltip" title="Earliest Average Submission Date: 1 bonus point">Early Bird</p>
    <p class="label label-success" data-toggle="tooltip" title="Fewest average lint errors: 1 bonus point">Prettiest</p>
</div>

<br>

<div class="row">
    <div class="alert alert-success">
        <b>Note:</b> You have all been assigned an anonymous identifier. If you're interested in seeing where you stack up just contact me and I will send it to you!
        You will also be able to display your real name on the leaderboard if you want to show off!
    </div>
</div>

{% endblock %}