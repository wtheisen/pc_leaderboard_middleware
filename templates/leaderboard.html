{% extends "base.html" %}
{% block body %}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    var refreshInterval = 60; // Refresh interval in seconds
    var countdown = refreshInterval;

    function updateLeaderboard() {
        $.getJSON("{{ url_for('leaderboard_data') }}", function(data) {
            // Update the leaderboard table with new data
            var tableBody = $("#leaderboardTable tbody");
            tableBody.empty(); // Clear existing rows

            $.each(data, function(index, entry) {
                var row = "<tr>";
                row += "<td>" + (entry.is_debug ? "*" : entry.position) + "</td>";
                row += "<td>" + entry.total_score.toFixed(2) + "</td>";
                row += "<td><a href='" + "{{ url_for('student_view', name='') }}" + entry.student_id + "'>" + entry.display_name + "</a></td>";
                row += "<td>" + entry.average_score.toFixed(2) + "</td>";
                row += "<td>" + entry.assignments_completed + " / 23 </td>";
                row += "<td><div class='progress-bar'><div class='progress' style='width: " + (entry.assignments_completed / 23 * 100).toFixed(0) + "%'></div></div></td>";
                row += "</tr>";
                tableBody.append(row);
            });
        });
    }

    function updateRecentSubmissions() {
        fetch('/recent_submissions')
            .then(response => response.json())
            .then(data => {
                var ticker = $("#recentSubmissionsTicker");
                ticker.empty();

                data.forEach(submission => {
                    const studentDisplayName = submission.student_name;
                    const studentLink = `/student/${submission.student_id}`;
                    const assignmentLink = submission.assignment_link;
                    console.log(`Student: ${studentDisplayName}, Assignment: ${submission.assignment}`);
                    var item = `<div class='ticker-item'>
                                    <b>Student:</b> <a href='${studentLink}'>${studentDisplayName}</a>, 
                                    <b>Assignment:</b> <a href='${assignmentLink}'>${submission.assignment}</a>, 
                                    <b>Time:</b> ${submission.submission_time}
                                </div>`;
                    ticker.append(item);
                });
            });
    }

    function startCountdown(duration) {
        const progressCircle = document.getElementById('refreshProgress');
        const countdownText = document.getElementById('countdownText');
        let timeLeft = duration;
        const totalDuration = duration;

        const countdownInterval = setInterval(() => {
            if (timeLeft <= 0) {
                clearInterval(countdownInterval);
                // Trigger your refresh action here
                console.log('Refreshing...');
                updateLeaderboard();
                updateRecentSubmissions();
                fetchSubmissionsData(); // Refresh the chart data
                // Reset the progress and start a new countdown
                progressCircle.style.background = 'conic-gradient(#3498db 0% 0%, #e0e0e0 0% 100%)';
                setTimeout(() => startCountdown(totalDuration), 1000); // Restart after 1 second
            } else {
                // Calculate the percentage of time left
                const percentage = ((totalDuration - timeLeft) / totalDuration) * 100;
                progressCircle.style.background = `conic-gradient(#3498db 0% ${percentage}%, #e0e0e0 ${percentage}% 100%)`;
            }
            timeLeft--;
        }, 1000);
    }

    $(document).ready(function() {
        updateLeaderboard();
        updateRecentSubmissions();
        fetchSubmissionsData(); // Initial chart data fetch
        startCountdown(60);
    });

    function fetchSubmissionsData() {
        fetch('/submissions_per_day')
            .then(response => response.json())
            .then(data => {
                console.log('Data fetched for chart:', data); // Debugging line

                const labels = data.map(entry => entry.date);
                const counts = data.map(entry => entry.count);

                const ctx = document.getElementById('submissionsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Submissions per Day',
                            data: counts,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            })
            .catch(error => console.error('Error fetching submissions data:', error));
    }

    // Fetch data and render chart on page load
    document.addEventListener('DOMContentLoaded', fetchSubmissionsData);
</script>

<div class="header-container">
    <input type="text" placeholder="Filter Leaderboard..." class="search-bar">
    <div class="progress-circle" id="refreshProgress">
        <span id="countdownText"></span>
    </div>
</div>

<br>

<div class="row">
    <table id="leaderboardTable" class="table condensed table-striped" border="2px solid black">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Total Points</th>
                <th>Student ID</th>
                <th>Average Assignment Points</th>
                <th>Challenges</th>
                <th>Progress</th>
            </tr>
        </thead>
        <tbody>
            <!-- Leaderboard data will be inserted here by JavaScript -->
        </tbody>
    </table>
</div>

<div class="row">
    <div class="page-header">
        <h2 id="logistics"><i class="fa fa-clock-o"></i> Recent Submissions</h2>
    </div>
</div>

<div class="row">
    <div id="recentSubmissionsTicker" class="ticker"></div>
</div>

<br>

<div class="row">
    <canvas id="submissionsChart" class="chart"></canvas>
</div>

<style>
.search-bar {
    width: 100%;
    border: 2px solid #ccc;
    border-radius: 10px;
}

.bonus {
    color: #4CAF50;
    font-weight: bold;
}
.progress-bar {
    width: 100%;
    height: 20px;
    background-color: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
}
.progress {
    height: 100%;
    background-color: #4CAF50;
    transition: width 0.5s ease-in-out;
}
.ticker {
    width: 100%;
    overflow: hidden;
    white-space: nowrap;
    box-sizing: border-box;
    position: relative;
    display: flex;
    align-items: center;
    border: 2px solid #ccc;
    border-radius: 8px;
    padding: 10px;
}
.ticker-item {
    display: inline-block;
    padding: 0 2rem;
    animation: ticker 30s linear infinite;
}
@keyframes ticker {
    0% { transform: translateX(250%); }
    100% { transform: translateX(-100%); }
}
.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(0, 0, 0, 0.1);
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 2s linear infinite;
    margin: 20px auto;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.progress-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: conic-gradient(#3498db 0% 0%, #e0e0e0 0% 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

#countdownText {
    position: absolute;
    font-size: 16px;
    color: #333;
}

.header-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
}

.search-bar {
    flex: 1;
    margin-right: 20px;
    padding: 5px;
    font-size: 16px;
}

.chart {
    width: 20%;
    height: 20%;
    border: 2px solid #ccc;
    border-radius: 8px;
    padding: 10px;
}
</style>

<script>
$(function () {
  $('[data-toggle="tooltip"]').tooltip();
});

function filterTable() {
    var input, filter, table, tr, td, i, txtValue;
    input = document.getElementById("searchInput");
    filter = input.value.toUpperCase();
    table = document.getElementById("leaderboardTable");
    tr = table.getElementsByTagName("tr");
    for (i = 1; i < tr.length; i++) {
        tr[i].style.display = "none";
        td = tr[i].getElementsByTagName("td");
        for (var j = 0; j < td.length; j++) {
            if (td[j]) {
                txtValue = td[j].textContent || td[j].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                    break;
                }
            }
        }
    }
}
</script>

{% endblock %}