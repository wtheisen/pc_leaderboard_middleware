{% extends "base.html" %}
{% block body %}

<style>
    .custom-card {
        border-radius: 10px;
        padding: 10px;
        border: 2px solid #1a1a1a;
    }
    .status-success {
        color: green;
        font-weight: bold;
    }
    .status-failure {
        color: red;
        font-weight: bold;
    }
    .label {
        display: inline-block;
        padding: 0.2em 0.6em 0.3em;
        font-size: 75%;
        font-weight: 700;
        line-height: 1;
        color: #fff;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25em;
    }
    .label-success {
        background-color: #5cb85c;
    }
    .label-warning {
        background-color: #f0ad4e;
    }
    .label-info {
        background-color: #5bc0de;
    }
    .label-caution {
        background-color: #f0ad4e;
    }
    .label-grey {
        background-color: #d3d3d3;
        color: #333;
    }

    #toggleViewButton {
        padding: 3px 10px; /* Decrease vertical padding */
        font-size: 14px;   /* Keep the font size */
        border-radius: 5px; /* Maintain the compact look */
        margin-left: 10px; /* Keep the space between the button and other elements */
    }

    .sort-button {
        cursor: pointer;
        margin-left: 5px;
        font-size: 12px;
    }
</style>

<div class="row">
    <div class="page-header">
        <h2 id="logistics"><i class="fa fa-calculator"></i> {{ assignment_name }} Statistics</h2>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card text-white bg-success custom-card">
            <div class="card-body">
                <h5 class="card-title">Submission Count</h5>
                <p class="card-text">{{ stats.submission_count }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card text-white bg-success custom-card">
            <div class="card-body">
                <h5 class="card-title">Average Code Score</h5>
                <p class="card-text">{{ "%.2f"|format(stats.avg_code_score) }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card text-white bg-info custom-card">
            <div class="card-body">
                <h5 class="card-title">Average Runtime</h5>
                <p class="card-text">{{ "%.3f"|format(stats.avg_runtime) }}s</p>
            </div>
        </div>
    </div>
</div>

<br>

<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card text-white bg-warning custom-card">
            <div class="card-body">
                <h5 class="card-title">Average Lint Errors</h5>
                <p class="card-text">{{ "%.2f"|format(stats.avg_lint_errors) }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card text-white bg-danger custom-card">
            <div class="card-body">
                <h5 class="card-title">Fastest Runtime</h5>
                <p class="card-text">{{ "%.3f"|format(stats.fastest_runtime) }}s</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card text-white bg-secondary custom-card">
            <div class="card-body">
                <h5 class="card-title">Highest Code Score</h5>
                <p class="card-text">{{ "%.2f"|format(stats.highest_code_score) }}</p>
            </div>
        </div>
    </div>
</div>

<br>

<div class="row">
    <div class="page-header">
        <h2 id="logistics"><i class="fa fa-hourglass-half"></i> {{ assignment_name }} Submissions</h2>
        <button id="toggleViewButton" class="btn btn-primary mb-3">Show Only Ranked Submissions</button>
    </div>
</div>

<div class="row">
    <table class="table table-condensed table-striped" border="2px solid black">
        <tr>
            <th>Submission Time (Rank) <i class="fa fa-sort sort-button" onclick="sortTable(0)"></i></th>
            <th>Student</th>
            <th>Code Score <i class="fa fa-sort sort-button" onclick="sortTable(2)"></i></th>
            <th>Runtime (Rank) <i class="fa fa-sort sort-button" onclick="sortTable(3)"></i></th>
            <th>Lint Errors (Rank) <i class="fa fa-sort sort-button" onclick="sortTable(4)"></i></th>
            <th>Status</th>
        </tr>
        {% for sub_data in submissions %}
        <tr class="submission-row {% if recent_submissions | selectattr('id', 'equalto', sub_data.submission.id) | list %}ranked{% endif %}">
            <td>{{ sub_data.submission.submission_time.strftime('%Y-%m-%d %H:%M:%S') }} 
                {% set recent_sub = recent_submissions | selectattr('student_id', 'equalto', sub_data.submission.student_id) | list | first %}
                {% if recent_sub and recent_sub.id == sub_data.submission.id %}
                    {% if recent_sub.submission_time_rank == 1 %}
                        <span class="label label-success">1st Place</span>
                    {% elif recent_sub.submission_time_rank == 2 %}
                        <span class="label label-caution">2nd Place</span>
                    {% elif recent_sub.submission_time_rank == 3 %}
                        <span class="label label-info">3rd Place</span>
                    {% elif recent_sub.submission_time_rank == 4 %}
                        <span class="label label-info">4th Place</span>
                    {% elif recent_sub.submission_time_rank == 5 %}
                        <span class="label label-info">5th Place</span>
                    {% else %}
                        <span class="label label-grey">{{ recent_sub.submission_time_rank }}th Place</span>
                    {% endif %}
                {% endif %}</td>
            <td><a href="{{ url_for('student_view', name=sub_data.submission.student_id) }}">{{ sub_data.display_name }}</a></td>
            <td>{{ "%.2f"|format(sub_data.submission.code_score) }}</td>
            <td>{{ "%.5f"|format(sub_data.submission.runtime) }} 
                {% if recent_sub and recent_sub.id == sub_data.submission.id %}
                    {% if recent_sub.runtime_rank == 1 %}
                        <span class="label label-success">1st Place</span>
                    {% elif recent_sub.runtime_rank == 2 %}
                        <span class="label label-caution">2nd Place</span>
                    {% elif recent_sub.runtime_rank == 3 %}
                        <span class="label label-info">3rd Place</span>
                    {% elif recent_sub.runtime_rank == 4 %}
                        <span class="label label-info">4th Place</span>
                    {% elif recent_sub.runtime_rank == 5 %}
                        <span class="label label-info">5th Place</span>
                    {% else %}
                        <span class="label label-grey">{{ recent_sub.runtime_rank }}th Place</span>
                    {% endif %}
                {% endif %}</td>
            <td>{{ "%.2f"|format(sub_data.submission.lint_errors) }} 
                {% if recent_sub and recent_sub.id == sub_data.submission.id %}
                    {% if recent_sub.lint_errors_rank == 1 %}
                        <span class="label label-success">1st Place</span>
                    {% elif recent_sub.lint_errors_rank == 2 %}
                        <span class="label label-caution">2nd Place</span>
                    {% elif recent_sub.lint_errors_rank == 3 %}
                        <span class="label label-info">3rd Place</span>
                    {% elif recent_sub.lint_errors_rank == 4 %}
                        <span class="label label-info">4th Place</span>
                    {% elif recent_sub.lint_errors_rank == 5 %}
                        <span class="label label-info">5th Place</span>
                    {% else %}
                        <span class="label label-grey">{{ recent_sub.lint_errors_rank }}th Place</span>
                    {% endif %}
                {% endif %}</td>
            <td class="{{ 'status-success' if sub_data.submission.status == 'Success' else 'status-failure' }}">
                {{ sub_data.submission.status }}
            </td>
        </tr>
        {% endfor %}
    </table>
</div>

<script>
    document.getElementById('toggleViewButton').addEventListener('click', function() {
        const rows = document.querySelectorAll('.submission-row');
        const showRankedOnly = this.textContent.includes('Show Only Ranked Submissions');
        
        rows.forEach(row => {
            if (showRankedOnly) {
                if (!row.classList.contains('ranked')) {
                    row.style.display = 'none';
                }
            } else {
                row.style.display = '';
            }
        });

        this.textContent = showRankedOnly ? 'Show All Submissions' : 'Show Only Ranked Submissions';
    });

    function sortTable(columnIndex) {
        const table = document.querySelector('.table');
        const rows = Array.from(table.rows).slice(1); // Exclude header row
        const isNumeric = columnIndex !== 1 && columnIndex !== 5; // Assume non-numeric for Student and Status columns

        rows.sort((a, b) => {
            const aText = a.cells[columnIndex].innerText.trim();
            const bText = b.cells[columnIndex].innerText.trim();

            if (isNumeric) {
                return parseFloat(aText) - parseFloat(bText);
            } else {
                return aText.localeCompare(bText);
            }
        });

        // Append sorted rows back to the table
        rows.forEach(row => table.appendChild(row));
    }
</script>

{% endblock %}
